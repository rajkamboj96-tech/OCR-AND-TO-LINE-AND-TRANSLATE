<!DOCTYPE html>
<html lang="pa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Master: OCR & 30-Line Translator</title>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        :root { 
            --bg: #0d1117; --panel: #161b22; --accent: #238636; --text: #c9d1d9;
            --blue: #1f6feb; --border: #30363d;
        }
        body { font-family: 'Segoe UI', "Noto Sans Gurmukhi", sans-serif; margin: 0; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 950px; margin: auto; background: var(--panel); padding: 30px; border-radius: 12px; border: 1px solid var(--border); }
        
        .upload-area { 
            border: 3px dashed var(--blue); border-radius: 15px; padding: 40px; text-align: center; 
            cursor: pointer; background: rgba(31, 111, 235, 0.05); margin-bottom: 20px;
        }
        
        .card-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; justify-content: center; }
        .card { width: 140px; background: #21262d; border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; font-size: 12px; }
        .progress-bar { height: 6px; background: #30363d; border-radius: 10px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: #58a6ff; width: 0%; transition: 0.2s; }

        .preview-box {
            width: 100%; height: 250px; background: #010409; color: #58a6ff; 
            border: 1px solid var(--border); border-radius: 8px; padding: 15px; 
            font-family: monospace; margin-top: 20px; display: none; box-sizing: border-box;
        }

        .status-bar { font-size: 1.1rem; color: #f1e05a; text-align: center; margin: 15px 0; font-weight: bold; }
        
        .btn { 
            width: 100%; padding: 15px; border-radius: 8px; font-weight: bold; 
            cursor: pointer; margin-top: 10px; border: none; font-size: 16px; transition: 0.2s;
        }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--accent); color: white; display: none; }
        
        #stopOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(13,17,23,0.98); z-index: 9999; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="text-align:center;">Batch OCR & 30-Line Translator</h2>
        
        <div class="upload-area" id="dropZone" onclick="document.getElementById('imgIn').click()">
            <p style="font-size: 1.2rem;">📂 <b>Add Images to Start</b></p>
            <p style="color: #8b949e;">Images will show below with progress bars</p>
            <input type="file" id="imgIn" accept="image/*" multiple hidden>
        </div>

        <div id="status" class="status-bar">Waiting for input...</div>

        <div class="card-container" id="ocrMainContainer"></div>

        <textarea id="editArea" class="preview-box" placeholder="Edit extracted text here..."></textarea>
        
        <button id="transBtn" class="btn btn-blue" style="display:none;" onclick="startBatchTranslation()">⚡ Start 30-Line Batch Translation</button>
        <button id="dlBtn" class="btn btn-green" onclick="generateDocx()">📥 Download Word Document</button>
    </div>

    <div id="stopOverlay">
        <h1 style="color: white; font-size: 40px;">Your file downloaded!</h1>
        <p style="color: #58a6ff; font-size: 50px;">Please refresh now.</p>
    </div>

    <script>
        let finalPairs = [];
        const BATCH_SIZE = 30;

        document.getElementById('imgIn').onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;

            const status = document.getElementById('status');
            const editArea = document.getElementById('editArea');
            const container = document.getElementById('ocrMainContainer');
            let fullText = "";

            status.innerText = "Processing Images (5x5)...";
            document.getElementById('dropZone').style.display = "none";

            for (let i = 0; i < files.length; i += 5) {
                const batch = files.slice(i, i + 5);
                const results = await Promise.all(batch.map(async (file, idx) => {
                    const gIdx = i + idx;
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `Page ${gIdx + 1}<div class="progress-bar"><div id="bar-${gIdx}" class="progress-fill"></div></div>`;
                    container.appendChild(card);

                    const res = await Tesseract.recognize(file, 'eng', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                document.getElementById(`bar-${gIdx}`).style.width = (m.progress * 100) + "%";
                            }
                        }
                    });
                    return res.data.text;
                }));
                fullText += results.join(" ") + " ";
            }

            editArea.value = fullText.replace(/\s+/g, ' ').trim();
            editArea.style.display = "block";
            status.innerText = "OCR Complete. Verify text and start translation.";
            document.getElementById('transBtn').style.display = "block";
        };

        async function startBatchTranslation() {
            const status = document.getElementById('status');
            const transBtn = document.getElementById('transBtn');
            const text = document.getElementById('editArea').value;
            
            const sentences = text.split(/(?<!\d|etc|Mr|Dr|Ms|Prof|Sr|Jr|St|Inc|Ltd)\s*[\.\!\?]+\s+/).filter(s => s.trim().length > 2);
            
            status.innerText = `Translating in batches of 30...`;
            transBtn.disabled = true;
            finalPairs = [];

            for (let i = 0; i < sentences.length; i += BATCH_SIZE) {
                const chunk = sentences.slice(i, i + BATCH_SIZE);
                status.innerText = `Translating: ${i + 1} to ${Math.min(i + BATCH_SIZE, sentences.length)} of ${sentences.length}`;

                const translatedChunk = await Promise.all(chunk.map(async (enLine) => {
                    try {
                        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=pa&dt=t&q=${encodeURIComponent(enLine)}`;
                        const r = await fetch(url);
                        const d = await r.json();
                        let paLine = "";
                        d[0].forEach(part => { if(part[0]) paLine += part[0]; });
                        return paLine;
                    } catch (err) { return "[Error]"; }
                }));

                translatedChunk.forEach((paText, idx) => {
                    finalPairs.push({
                        en: `${finalPairs.length + 1}. ${chunk[idx].trim()}.`,
                        pa: paText.trim()
                    });
                });
            }

            status.innerText = "✅ Ready for download!";
            document.getElementById('dlBtn').style.display = "block";
            transBtn.style.display = "none";
        }

        function xmlSafe(str) {
            return str.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&apos;','"':'&quot;'}[c]));
        }

        async function generateDocx() {
            const zip = new JSZip();
            const bodyXml = finalPairs.map(item => `
                <w:p><w:r><w:t>${xmlSafe(item.en)}</w:t></w:r></w:p>
                <w:p><w:r><w:rPr><w:color w:val="FF0000"/></w:rPr><w:t>${xmlSafe(item.pa)}</w:t></w:r></w:p>
            `).join('');

            const mainXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:body>${bodyXml}</w:body></w:document>`;
            
            zip.file("word/document.xml", mainXml);
            zip.file("_rels/.rels", `<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Target="word/document.xml" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument"/></Relationships>`);
            zip.file("[Content_Types].xml", `<?xml version="1.0" encoding="UTF-8"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/></Types>`);

            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "Final_Punjabi_Translation.docx";
            link.click();
            
            document.getElementById('stopOverlay').style.display = "flex";
        }
    </script>
</body>
</html>